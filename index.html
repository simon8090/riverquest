<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>汙水接管查詢 Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    html, body { height: 100%; } #map { height: 100%; }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  </style>
</head>

<body class="h-screen bg-slate-50 text-slate-900">
  <div class="h-full grid grid-cols-12 gap-0">

    <!-- LEFT -->
    <aside class="col-span-12 lg:col-span-4 xl:col-span-3 border-r bg-white p-4 overflow-auto">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h1 class="text-lg font-semibold leading-tight">汙水接管查詢 Demo</h1>
          <div class="text-xs text-slate-500 mt-1">門檻：<span class="font-extrabold text-slate-900">10m</span></div>
        </div>

        <!-- BIG CTA -->
        <div class="flex gap-2">
          <a href="./support.html" target="_blank"
             class="px-4 py-3 rounded-2xl bg-amber-500 text-white text-base font-extrabold hover:bg-amber-400">
            支持我們
          </a>
          <a href="./workshop.html" target="_blank"
             class="px-4 py-3 rounded-2xl bg-slate-900 text-white text-base font-extrabold hover:bg-slate-800">
            預約工作坊
          </a>
        </div>
      </div>

      <!-- SUPER CLEAR STATUS -->
      <div class="mt-4 p-4 rounded-2xl border bg-slate-50">
        <div id="statusPill" class="inline-flex items-center px-4 py-3 rounded-full text-base font-extrabold bg-slate-200 text-slate-700">
          尚未查詢
        </div>
        <div id="statusMeta" class="mt-2 text-sm text-slate-700"></div>
        <div id="statusTiny" class="mt-2 text-xs text-slate-500 mono"></div>
      </div>

      <!-- ADDRESS -->
      <div class="mt-5">
        <div class="text-sm font-semibold">輸入地址</div>
        <div class="mt-2 flex gap-2">
          <input id="addr" class="w-full px-3 py-2 rounded-xl border text-sm"
                 placeholder="例：台北市大安區羅斯福路四段1號" />
          <button id="searchBtn" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm font-extrabold hover:bg-emerald-500">
            查詢
          </button>
        </div>
        <div class="mt-2 flex gap-2">
          <button id="useClick" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm font-bold">
            地圖點選
          </button>
          <button id="productBtn" class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm font-bold">
            合併處理淨化槽
          </button>
        </div>
      </div>

      <!-- (Optional) Load status -->
      <div class="mt-4 text-xs text-slate-500">
        管線：<span id="pipeStatus">載入中…</span>
      </div>

      <!-- Hint box -->
      <div id="hintBox" class="mt-4 p-4 rounded-2xl border bg-white hidden">
        <div id="hintTitle" class="text-base font-extrabold"></div>
        <div id="hintText" class="mt-2 text-sm text-slate-700"></div>
        <div class="mt-3 flex gap-2">
          <a id="hintPrimary" href="#" target="_blank"
             class="px-4 py-3 rounded-2xl bg-slate-900 text-white text-sm font-extrabold hover:bg-slate-800">
            立即前往
          </a>
          <button id="hintClose" class="px-4 py-3 rounded-2xl border bg-white hover:bg-slate-50 text-sm font-bold">
            關閉
          </button>
        </div>
      </div>

      <div class="mt-4 text-xs text-slate-400">※ Demo：點到最近管線距離 ≤ 10m → 推定已接管</div>
    </aside>

    <!-- RIGHT -->
    <main class="col-span-12 lg:col-span-8 xl:col-span-9">
      <div id="map"></div>
    </main>
  </div>

  <!-- PRODUCT MODAL -->
  <div id="productModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="w-full max-w-lg rounded-2xl bg-white p-5 shadow-xl">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-base font-extrabold">合併處理淨化槽</div>
          <div class="text-xs text-slate-500 mt-1">（可放示意圖）</div>
        </div>
        <button class="px-3 py-1 rounded-lg border hover:bg-slate-50 text-sm font-bold" onclick="closeModal('productModal')">關閉</button>
      </div>

      <div class="mt-4 rounded-xl border bg-slate-50 p-3">
        <!-- 你有示意圖就放到 repo，例如 images/tank.png，然後改 src -->
        <img id="productImg" src="" alt="淨化槽示意圖"
             class="w-full h-56 object-contain rounded-lg bg-white border"
             onerror="this.style.display='none'; document.getElementById('imgFallback').classList.remove('hidden');"/>
        <div id="imgFallback" class="hidden text-sm text-slate-600">
          （尚未放圖）
        </div>
      </div>

      <div class="mt-4 flex gap-2">
        <a href="./workshop.html" target="_blank"
           class="flex-1 px-4 py-3 rounded-2xl bg-slate-900 text-white text-sm font-extrabold hover:bg-slate-800 text-center">
          預約工作坊
        </a>
        <a href="./support.html" target="_blank"
           class="flex-1 px-4 py-3 rounded-2xl bg-amber-500 text-white text-sm font-extrabold hover:bg-amber-400 text-center">
          支持我們
        </a>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const THRESHOLD_M = 10;
    const PIPE_GEOJSON_URL = "./data/sewer_pipes.geojson";

    // ===== MAP =====
    const map = L.map("map").setView([25.0375, 121.5637], 12);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19, attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const el = (id) => document.getElementById(id);
    const pipeStatus = el("pipeStatus");
    const addr = el("addr");
    const searchBtn = el("searchBtn");
    const useClick = el("useClick");
    const productBtn = el("productBtn");

    const statusPill = el("statusPill");
    const statusMeta = el("statusMeta");
    const statusTiny = el("statusTiny");

    const hintBox = el("hintBox");
    const hintTitle = el("hintTitle");
    const hintText = el("hintText");
    const hintPrimary = el("hintPrimary");
    const hintClose = el("hintClose");

    let pipesGeoJSON = null;
    let pipesLayer = null;

    let queryMarker = null, nearestLayer = null, connectLine = null, bufferCircle = null;
    let clickMode = false;

    // ===== MODAL =====
    function openModal(id) { el(id).classList.remove("hidden"); el(id).classList.add("flex"); }
    function closeModal(id) { el(id).classList.add("hidden"); el(id).classList.remove("flex"); }
    window.openModal = openModal; window.closeModal = closeModal;

    // ===== STATUS (KEY) =====
    function setConnected(dist) {
      statusPill.className = "inline-flex items-center px-4 py-3 rounded-full text-base font-extrabold bg-emerald-100 text-emerald-800";
      statusPill.textContent = "✅ 已接管（推定）";
      statusMeta.innerHTML = `<span class="font-extrabold text-emerald-800">距離最近管線：</span><span class="font-extrabold">${dist.toFixed(1)}m</span>`;
      statusTiny.textContent = `（≤ ${THRESHOLD_M}m）`;
      showHint(true);
    }
    function setNot(dist) {
      statusPill.className = "inline-flex items-center px-4 py-3 rounded-full text-base font-extrabold bg-red-100 text-red-800";
      statusPill.textContent = "⚠️ 未接管（推定）";
      statusMeta.innerHTML = `<span class="font-extrabold text-red-800">距離最近管線：</span><span class="font-extrabold">${dist.toFixed(1)}m</span>`;
      statusTiny.textContent = `（> ${THRESHOLD_M}m）`;
      showHint(false);
    }
    function setIdle(msg="輸入地址或點地圖") {
      statusPill.className = "inline-flex items-center px-4 py-3 rounded-full text-base font-extrabold bg-slate-200 text-slate-700";
      statusPill.textContent = "尚未查詢";
      statusMeta.textContent = msg;
      statusTiny.textContent = "";
      hintBox.classList.add("hidden");
    }

    function showHint(isConnected) {
      hintBox.classList.remove("hidden");
      if (isConnected) {
        hintTitle.className = "text-base font-extrabold text-emerald-700";
        hintTitle.textContent = "✅ 建議：預約工作坊確認戶內接管";
        hintText.innerHTML = `<span class="font-extrabold">下一步：</span>帶地址來，我們協助判讀與建議。`;
        hintPrimary.textContent = "前往預約工作坊";
        hintPrimary.href = "./workshop.html";
        hintPrimary.onclick = null;
      } else {
        hintTitle.className = "text-base font-extrabold text-red-700";
        hintTitle.textContent = "⚠️ 警示：建議評估「合併處理淨化槽」";
        hintText.innerHTML = `<span class="font-extrabold">可考慮：</span>合併處理淨化槽方案。`;
        hintPrimary.textContent = "查看淨化槽";
        hintPrimary.href = "javascript:void(0)";
        hintPrimary.onclick = () => openModal("productModal");
      }
    }
    hintClose.addEventListener("click", () => hintBox.classList.add("hidden"));

    // ===== GEOJSON HELPERS =====
    function toFC(g) {
      if (!g) return null;
      if (g.type === "FeatureCollection") return g;
      if (g.type === "Feature") return { type:"FeatureCollection", features:[g] };
      return { type:"FeatureCollection", features:[{ type:"Feature", properties:{}, geometry:g }] };
    }
    function explodeLines(fc) {
      const out = [];
      for (const f of (fc.features || [])) {
        const g = f.geometry; if (!g) continue;
        if (g.type === "LineString") out.push(f);
        else if (g.type === "MultiLineString") {
          for (const coords of (g.coordinates || [])) {
            out.push({ type:"Feature", properties:{...(f.properties||{})}, geometry:{ type:"LineString", coordinates: coords } });
          }
        }
      }
      return out;
    }

    // ===== LOAD PIPES =====
    async function loadPipes() {
      const r = await fetch(PIPE_GEOJSON_URL, { cache:"no-store" });
      if (!r.ok) throw new Error("pipe fetch failed");
      pipesGeoJSON = await r.json();

      if (pipesLayer) map.removeLayer(pipesLayer);
      pipesLayer = L.geoJSON(toFC(pipesGeoJSON), { style:{ weight:2, opacity:0.7 } }).addTo(map);

      pipeStatus.textContent = "已載入";
      try { map.fitBounds(pipesLayer.getBounds(), { padding:[20,20] }); } catch {}
    }

    // ===== GEOCODE =====
    async function geocodeTW(q) {
      const url = "https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&countrycodes=tw&q=" + encodeURIComponent(q);
      const resp = await fetch(url, { headers:{ "Accept":"application/json", "Accept-Language":"zh-TW" } });
      const data = await resp.json();
      if (!data?.length) return null;
      return { lat:+data[0].lat, lon:+data[0].lon };
    }

    // ===== NEAREST =====
    function nearest(latlng) {
      if (!pipesGeoJSON) return null;
      const lines = explodeLines(toFC(pipesGeoJSON));
      if (!lines.length) return null;

      const pt = turf.point([latlng.lng, latlng.lat]);
      let best = null;

      for (const line of lines) {
        try {
          const snapped = turf.nearestPointOnLine(line, pt, { units:"meters" });
          const d = snapped.properties?.dist;
          if (best === null || d < best.dist) best = { dist:d, line, snapped };
        } catch {}
      }
      return best;
    }

    function clearGraphics(){
      if (queryMarker) map.removeLayer(queryMarker), queryMarker=null;
      if (nearestLayer) map.removeLayer(nearestLayer), nearestLayer=null;
      if (connectLine) map.removeLayer(connectLine), connectLine=null;
      if (bufferCircle) map.removeLayer(bufferCircle), bufferCircle=null;
    }

    function renderCheck(latlng){
      clearGraphics();

      queryMarker = L.marker([latlng.lat, latlng.lng], { draggable:true }).addTo(map);
      queryMarker.on("dragend", () => renderCheck(queryMarker.getLatLng()));

      bufferCircle = L.circle([latlng.lat, latlng.lng], { radius:THRESHOLD_M, weight:1, opacity:0.7, fillOpacity:0.08 }).addTo(map);

      const res = nearest(latlng);
      if (!res) { setIdle("請先確保管線已載入"); return; }

      nearestLayer = L.geoJSON(res.line, { style:{ weight:5, opacity:0.9 } }).addTo(map);

      const snappedLL = L.latLng(res.snapped.geometry.coordinates[1], res.snapped.geometry.coordinates[0]);
      connectLine = L.polyline([latlng, snappedLL], { weight:2, opacity:0.8, dashArray:"6 6" }).addTo(map);

      (res.dist <= THRESHOLD_M) ? setConnected(res.dist) : setNot(res.dist);
    }

    // ===== EVENTS =====
    searchBtn.addEventListener("click", async () => {
      const q = addr.value.trim(); if (!q) return;
      const g = await geocodeTW(q); if (!g) return;
      const p = L.latLng(g.lat, g.lon);
      map.setView(p, 18);
      renderCheck(p);
    });
    addr.addEventListener("keydown", (e)=>{ if(e.key==="Enter") searchBtn.click(); });

    useClick.addEventListener("click", () => {
      clickMode = !clickMode;
      useClick.className = clickMode
        ? "px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-extrabold hover:bg-slate-800"
        : "px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm font-bold";
    });
    map.on("click", (ev) => { if (clickMode) renderCheck(ev.latlng); });

    productBtn.addEventListener("click", () => openModal("productModal"));
    el("productModal").addEventListener("click", (e)=>{ if(e.target.id==="productModal") closeModal("productModal"); });

    // ===== INIT =====
    setIdle();
    loadPipes()
      .then(()=>{})
      .catch(()=>{ pipeStatus.textContent="載入失敗（請確認 data/sewer_pipes.geojson 路徑）"; });
  </script>
</body>
</html>
