<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RiverQuest | 任務化 × 可視化 × 可分享 Demo</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Leaflet (成果牆地圖) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .river-bg { background: linear-gradient(135deg, #0ea5e9 0%, #2dd4bf 100%); }
    .success-pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(14, 165, 233, 0); }
      100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
    }
    #captureCanvas, #shareCanvas { display: none; }
    .loading-bar { width: 0%; animation: load 1.2s forwards; }
    @keyframes load { to { width: 100%; } }

    button { -webkit-tap-highlight-color: transparent; }

    /* Leaflet 容器 */
    #map { height: 240px; }

    /* textarea 更好看 */
    textarea { resize: none; }
  </style>
</head>

<body class="bg-gray-50 pb-28">

  <!-- Header -->
  <header class="river-bg text-white px-6 pt-10 pb-16 rounded-b-[3rem] shadow-xl relative overflow-hidden">
    <div class="relative z-10 flex justify-between items-end gap-4">
      <div class="min-w-0">
        <h1 class="text-3xl font-black italic tracking-tighter">RiverQuest</h1>
        <div id="geo-status" class="bg-white/20 backdrop-blur-md rounded-full px-3 py-1 text-[10px] mt-2 inline-flex items-center max-w-full">
          <span id="geo-dot" class="w-2 h-2 bg-yellow-300 rounded-full mr-2 animate-ping"></span>
          <span id="geo-text" class="truncate">正在偵測台中河川點位...</span>
        </div>
        <p class="text-[11px] opacity-90 mt-2 leading-snug">
          任務化 × 可視化 × 可分享 —— 讓每個人用 10 分鐘，重新與河建立關係。
        </p>
      </div>
      <div class="text-right shrink-0">
        <p class="text-[10px] opacity-80 uppercase font-bold">Total Power</p>
        <p id="points" class="text-4xl font-black">0</p>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <main class="px-6 -mt-8 relative z-20 space-y-6">
    <!-- 任務頁 -->
    <section id="tab-quest" class="space-y-6">
      <!-- 任務清單 -->
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-blue-100">
        <div class="p-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-black text-gray-800">選一個 3–10 分鐘小任務</h2>
              <p class="text-gray-400 text-xs mt-1">拍照之外，也能留下「一句話」：願望 / 問題 / 生物觀察。</p>
            </div>
            <span class="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full">TASKS</span>
          </div>

          <div id="mission-list" class="mt-5 grid grid-cols-1 gap-3"></div>
        </div>
      </div>

      <!-- 相機區 -->
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-blue-100">
        <div class="relative aspect-[4/3] bg-black">
          <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
          <div class="absolute inset-0 border-[15px] border-white/10 pointer-events-none"></div>

          <div class="absolute top-4 left-4 right-4 flex items-center justify-between gap-2">
            <div class="bg-white/85 backdrop-blur px-3 py-2 rounded-2xl shadow text-[11px] font-bold text-gray-800">
              <i class="fa-solid fa-bolt text-blue-600 mr-1"></i>
              <span id="active-mission-badge">請先選擇任務</span>
            </div>
            <button id="switchCamBtn" class="bg-white/80 backdrop-blur px-3 py-2 rounded-2xl shadow text-[11px] font-black text-gray-700 active:scale-95 transition">
              <i class="fa-solid fa-rotate mr-1"></i> 轉鏡頭
            </button>
          </div>
        </div>

        <div class="p-8 text-center">
          <h3 class="text-xl font-bold text-gray-800 mb-1">拍下眼前的河流</h3>
          <p class="text-gray-400 text-xs mb-6">你的回報會即時進入成果牆，並生成分享卡（含文字）。</p>

          <button onclick="takeAction()" id="shutter"
                  class="success-pulse w-20 h-20 bg-white border-8 border-blue-500 rounded-full mx-auto flex items-center justify-center active:scale-90 transition disabled:opacity-40 disabled:animate-none disabled:cursor-not-allowed"
                  disabled>
            <div class="w-12 h-12 bg-blue-500 rounded-full"></div>
          </button>

          <p id="hint" class="text-[11px] text-gray-400 mt-4">
            先選一個任務，填寫文字後再按快門完成回報。
          </p>

          <!-- ✅ 任務文字輸入區（依任務切換） -->
          <div id="mission-form" class="mt-5 max-w-md mx-auto text-left">
            <!-- 未選任務 -->
            <div id="form-none" class="rounded-2xl border border-gray-100 bg-gray-50 p-4">
              <div class="text-xs font-black text-gray-500 tracking-widest uppercase">Input</div>
              <div class="text-sm font-black text-gray-800 mt-2">請先選擇任務</div>
              <div class="text-[11px] text-gray-500 mt-1">選完後這裡會出現對應的文字框。</div>
            </div>

            <!-- 願望 -->
            <div id="form-wish" class="hidden rounded-2xl border border-blue-100 bg-blue-50/50 p-4">
              <div class="flex items-center justify-between">
                <div class="text-xs font-black text-blue-600 tracking-widest uppercase">Wish</div>
                <span class="text-[10px] font-black text-blue-700 bg-blue-100 px-2 py-1 rounded-full">必填</span>
              </div>
              <label class="block text-sm font-black text-gray-800 mt-2">寫一句河的願望</label>
              <textarea id="wishText" rows="3" maxlength="80"
                        class="mt-2 w-full rounded-2xl border border-blue-100 bg-white px-4 py-3 text-sm outline-none focus:ring-4 focus:ring-blue-200"
                        placeholder="例：希望你更清澈、更安全，讓孩子也敢靠近你。"></textarea>
              <div class="mt-3 grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">心情（選填）</label>
                  <select id="wishMood" class="mt-1 w-full rounded-2xl border border-blue-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-blue-200">
                    <option value="">不選</option>
                    <option>希望</option>
                    <option>心疼</option>
                    <option>溫柔</option>
                    <option>想改變</option>
                  </select>
                </div>
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">#標籤（選填）</label>
                  <input id="wishTag" maxlength="18"
                         class="mt-1 w-full rounded-2xl border border-blue-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-blue-200"
                         placeholder="例：#今天給河10分鐘">
                </div>
              </div>
              <div class="text-[11px] text-gray-500 mt-2">提示：願望句子會出現在成果牆與分享卡。</div>
            </div>

            <!-- 問題回報 -->
            <div id="form-issue" class="hidden rounded-2xl border border-amber-100 bg-amber-50/50 p-4">
              <div class="flex items-center justify-between">
                <div class="text-xs font-black text-amber-700 tracking-widest uppercase">Issue</div>
                <span class="text-[10px] font-black text-amber-800 bg-amber-100 px-2 py-1 rounded-full">必填</span>
              </div>
              <label class="block text-sm font-black text-gray-800 mt-2">回報 1 個河岸問題</label>

              <div class="mt-2 grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">問題分類（必填）</label>
                  <select id="issueType" class="mt-1 w-full rounded-2xl border border-amber-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-amber-200">
                    <option value="">請選擇</option>
                    <option>垃圾 / 塑膠</option>
                    <option>異味 / 排放</option>
                    <option>水色異常 / 泡沫</option>
                    <option>步道破損 / 危險</option>
                    <option>淤積 / 堵塞</option>
                    <option>其他</option>
                  </select>
                </div>
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">嚴重度（選填）</label>
                  <select id="issueSeverity" class="mt-1 w-full rounded-2xl border border-amber-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-amber-200">
                    <option value="">不選</option>
                    <option>輕微</option>
                    <option>中等</option>
                    <option>嚴重</option>
                  </select>
                </div>
              </div>

              <label class="block text-[11px] font-bold text-gray-700 mt-3">一句話描述（必填）</label>
              <textarea id="issueText" rows="3" maxlength="90"
                        class="mt-1 w-full rounded-2xl border border-amber-100 bg-white px-4 py-3 text-sm outline-none focus:ring-4 focus:ring-amber-200"
                        placeholder="例：橋下垃圾堆積，風吹就會進河裡。"></textarea>

              <div class="mt-3">
                <label class="block text-[11px] font-bold text-gray-700">位置補充（選填）</label>
                <input id="issueWhere" maxlength="40"
                       class="mt-1 w-full rounded-2xl border border-amber-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-amber-200"
                       placeholder="例：步道入口右側、橋下">
              </div>

              <div class="text-[11px] text-gray-500 mt-2">提示：分類＋一句話會出現在地圖 popup 與分享卡。</div>
            </div>

            <!-- 生物紀錄 -->
            <div id="form-species" class="hidden rounded-2xl border border-emerald-100 bg-emerald-50/50 p-4">
              <div class="flex items-center justify-between">
                <div class="text-xs font-black text-emerald-700 tracking-widest uppercase">Species</div>
                <span class="text-[10px] font-black text-emerald-800 bg-emerald-100 px-2 py-1 rounded-full">必填</span>
              </div>
              <label class="block text-sm font-black text-gray-800 mt-2">紀錄一種生物</label>

              <div class="mt-2 grid grid-cols-2 gap-2">
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">生物名稱（必填）</label>
                  <input id="spName" maxlength="28"
                         class="mt-1 w-full rounded-2xl border border-emerald-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-emerald-200"
                         placeholder="例：白鷺鷥 / 蜻蜓 / 青蛙">
                </div>
                <div>
                  <label class="block text-[11px] font-bold text-gray-700">數量（選填）</label>
                  <input id="spCount" type="number" min="1"
                         class="mt-1 w-full rounded-2xl border border-emerald-100 bg-white px-3 py-2 text-sm outline-none focus:ring-4 focus:ring-emerald-200"
                         placeholder="例：3">
                </div>
              </div>

              <div class="mt-3">
                <label class="block text-[11px] font-bold text-gray-700">想法 / 觀察（選填）</label>
                <textarea id="spNote" rows="2" maxlength="80"
                          class="mt-1 w-full rounded-2xl border border-emerald-100 bg-white px-4 py-3 text-sm outline-none focus:ring-4 focus:ring-emerald-200"
                          placeholder="例：牠們在岸邊覓食，這段棲地看起來還不錯。"></textarea>
              </div>

              <div class="text-[11px] text-gray-500 mt-2">提示：名稱（+數量）會出現在成果牆與分享卡。</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 成果牆頁 -->
    <section id="tab-wall" class="hidden space-y-6">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-blue-100">
        <div class="p-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-lg font-black text-gray-800">成果牆（可視化）</h2>
              <p class="text-gray-400 text-xs mt-1">今天完成多少、在哪些點位、累積多少能量；也能看到文字內容。</p>
            </div>
            <span class="text-[10px] font-black text-emerald-700 bg-emerald-50 px-3 py-1 rounded-full">LIVE</span>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <div class="rounded-2xl border border-gray-100 p-4">
              <p class="text-[10px] font-black text-gray-400 uppercase">Today Quests</p>
              <p id="today-count" class="text-3xl font-black text-gray-800 mt-1">0</p>
              <p class="text-[11px] text-gray-400 mt-1">今日完成任務數</p>
            </div>
            <div class="rounded-2xl border border-gray-100 p-4">
              <p class="text-[10px] font-black text-gray-400 uppercase">Today Power</p>
              <p id="today-points" class="text-3xl font-black text-gray-800 mt-1">0</p>
              <p class="text-[11px] text-gray-400 mt-1">今日累積守護能量</p>
            </div>
          </div>

          <div class="mt-5 rounded-2xl overflow-hidden border border-gray-100">
            <div id="map"></div>
          </div>

          <div class="mt-5">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-sm font-black text-gray-800">最新回報（含文字）</h3>
              <button onclick="clearDemoData()" class="text-[11px] font-black text-gray-400 hover:text-gray-600">
                清除 demo 資料
              </button>
            </div>
            <div id="recent-list" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- 報告收束句（故事感） -->
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-blue-100">
        <div class="p-6">
          <div class="text-xs font-black text-blue-500 tracking-widest uppercase">Closing</div>
          <h3 class="text-xl font-black text-gray-800 mt-2 leading-snug">
            我們不是從「我要做一個平台」開始，<br>
            而是從一個很小的疑問開始：
          </h3>
          <p class="text-gray-700 mt-3 leading-relaxed text-sm">
            為什麼河就在城市旁邊，卻始終離年輕人那麼遠？
            <br><br>
            當我們走近後才發現，問題不只是污染，
            而是「人沒有被邀請參與」。
            <br><br>
            所以我們想做的，是把河川永續從「議題」變成「入口」：
            讓每個人都能用 10 分鐘，開始與河重新建立關係。
          </p>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-gray-200 px-6 py-3 z-40">
    <div class="max-w-xl mx-auto grid grid-cols-2 gap-3">
      <button id="btn-quest" onclick="switchTab('quest')"
              class="river-bg text-white font-black py-3 rounded-2xl shadow-lg shadow-blue-500/20 active:scale-[0.99] transition">
        <i class="fa-solid fa-flag-checkered mr-2"></i> 任務
      </button>
      <button id="btn-wall" onclick="switchTab('wall')"
              class="bg-gray-100 text-gray-700 font-black py-3 rounded-2xl active:scale-[0.99] transition">
        <i class="fa-solid fa-chart-simple mr-2"></i> 成果牆
      </button>
    </div>
  </nav>

  <!-- 完成彈窗 -->
  <div id="modal" class="fixed inset-0 bg-sky-900/95 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="w-full max-w-sm">
      <div class="bg-white rounded-[2rem] overflow-hidden shadow-2xl transform rotate-2">
        <div class="relative">
          <img id="photo" class="w-full h-72 object-cover" alt="captured">
          <div class="absolute bottom-4 left-4 right-4 bg-white/90 backdrop-blur p-3 rounded-xl shadow-lg">
            <div class="h-1 bg-gray-100 rounded-full overflow-hidden">
              <div class="h-full bg-blue-500 loading-bar"></div>
            </div>
            <p class="text-[10px] font-bold text-blue-600 mt-2 italic">
              SYNCING TO RIVER_WALL...
            </p>
          </div>
        </div>
        <div class="p-6 text-center">
          <div class="text-xs font-black text-blue-500 tracking-widest uppercase">Quest Completed</div>
          <h3 id="modal-title" class="text-2xl font-black text-gray-800 my-1">守護能量 +0</h3>
          <p id="modal-sub" class="text-gray-400 text-[10px] mb-2">您的行動已即時同步至成果牆</p>

          <!-- ✅ 顯示文字摘要 -->
          <div id="modal-summary" class="mx-auto mb-4 max-w-xs rounded-2xl bg-gray-50 border border-gray-100 p-3 text-left">
            <div class="text-[10px] font-black text-gray-400 uppercase">Your Text</div>
            <div id="modal-summary-text" class="text-sm font-black text-gray-800 mt-1">—</div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <button onclick="openShareCard()" class="w-full bg-gray-900 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition">
              <i class="fa-solid fa-share-nodes mr-2"></i> 分享卡
            </button>
            <button onclick="closeModalToWall()" class="w-full river-bg text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-500/30 active:scale-95 transition">
              去成果牆
            </button>
          </div>

          <button onclick="closeModal()" class="mt-3 text-[11px] font-black text-gray-400 hover:text-gray-600">
            繼續任務
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 分享卡彈窗 -->
  <div id="shareModal" class="fixed inset-0 bg-gray-900/90 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm">
    <div class="w-full max-w-sm">
      <div class="bg-white rounded-[2rem] overflow-hidden shadow-2xl">
        <div class="p-5 flex items-center justify-between">
          <div>
            <div class="text-xs font-black text-emerald-600 tracking-widest uppercase">Share Card</div>
            <div class="text-sm font-black text-gray-800">把行動帶到社群</div>
          </div>
          <button onclick="closeShare()" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-600 font-black active:scale-95">✕</button>
        </div>

        <div class="px-5 pb-5">
          <img id="sharePreview" class="w-full rounded-2xl border border-gray-100" alt="share-card" />

          <div class="grid grid-cols-2 gap-3 mt-4">
            <button onclick="nativeShare()" class="w-full bg-gray-900 text-white font-black py-3 rounded-2xl active:scale-95 transition">
              <i class="fa-solid fa-arrow-up-from-bracket mr-2"></i> 分享
            </button>
            <a id="downloadBtn" class="w-full river-bg text-white font-black py-3 rounded-2xl text-center active:scale-95 transition" download="RiverQuest_share.png">
              <i class="fa-solid fa-download mr-2"></i> 下載
            </a>
          </div>

          <p class="text-[11px] text-gray-400 mt-3 leading-snug">
            手機支援 Web Share 時會直接跳分享；不支援就用「下載」發到 IG/限動。
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Offscreen canvases -->
  <canvas id="captureCanvas"></canvas>
  <canvas id="shareCanvas"></canvas>

  <script>
    // ---------------------------
    // Demo 設定：台中（東海大學附近）河川點位（示意）
    // ---------------------------
    const RIVER_SPOTS = [
      { name: "筏子溪｜東海大學段（示意）", lat: 24.1818, lon: 120.6026 },
      { name: "筏子溪｜台灣大道橋（示意）", lat: 24.1715, lon: 120.6125 },
      { name: "筏子溪｜福科路段（示意）", lat: 24.1890, lon: 120.5965 },
      { name: "大肚溪｜龍井河濱（示意）", lat: 24.1810, lon: 120.5380 },
      { name: "大肚溪｜烏日段（示意）", lat: 24.1055, lon: 120.6020 }
    ];
    const NEAR_RADIUS_KM = 3.0;

    // 你要的 3 個核心任務（含文字框）
    const MISSIONS = [
      { id: "wish1",   title: "寫一句河的願望", minutes: 3, points: 40, icon: "fa-pen-nib", hint: "寫下願望 + 拍河景" },
      { id: "report1", title: "回報 1 個河岸問題", minutes: 8, points: 70, icon: "fa-triangle-exclamation", hint: "選分類 + 一句話 + 拍照" },
      { id: "bio1",    title: "記錄 1 種生物", minutes: 7, points: 60, icon: "fa-leaf", hint: "輸入名稱（可選數量/想法）+ 拍照" }
    ];

    // localStorage keys
    const LS_POINTS  = "rq_total_points_v1";
    const LS_ACTIONS = "rq_actions_v1";

    // DOM
    const video = document.getElementById("video");
    const captureCanvas = document.getElementById("captureCanvas");
    const shareCanvas = document.getElementById("shareCanvas");
    const pointsDisp = document.getElementById("points");
    const geoText = document.getElementById("geo-text");
    const geoDot = document.getElementById("geo-dot");
    const missionList = document.getElementById("mission-list");
    const activeMissionBadge = document.getElementById("active-mission-badge");
    const shutter = document.getElementById("shutter");
    const hint = document.getElementById("hint");

    // forms
    const formNone    = document.getElementById("form-none");
    const formWish    = document.getElementById("form-wish");
    const formIssue   = document.getElementById("form-issue");
    const formSpecies = document.getElementById("form-species");

    const wishText = document.getElementById("wishText");
    const wishMood = document.getElementById("wishMood");
    const wishTag  = document.getElementById("wishTag");

    const issueType     = document.getElementById("issueType");
    const issueSeverity = document.getElementById("issueSeverity");
    const issueText     = document.getElementById("issueText");
    const issueWhere    = document.getElementById("issueWhere");

    const spName  = document.getElementById("spName");
    const spCount = document.getElementById("spCount");
    const spNote  = document.getElementById("spNote");

    // State
    let facingMode = "environment";
    let currentStream = null;
    let selectedMissionId = null;

    let userLoc = { lat: null, lon: null, place: "未定位" };
    let leafletMap = null;
    let markersLayer = null;

    // ---------------------------
    // Utils
    // ---------------------------
    function kmBetween(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function fmtTime(ts) {
      const d = new Date(ts);
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function todayKey(ts = Date.now()) {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function getMission(id) {
      return MISSIONS.find(m => m.id === id);
    }

    function loadTotalPoints() {
      const raw = localStorage.getItem(LS_POINTS);
      return raw ? parseInt(raw, 10) : 1240;
    }

    function saveTotalPoints(v) {
      localStorage.setItem(LS_POINTS, String(v));
    }

    function loadActions() {
      try {
        return JSON.parse(localStorage.getItem(LS_ACTIONS) || "[]");
      } catch {
        return [];
      }
    }

    function saveActions(arr) {
      localStorage.setItem(LS_ACTIONS, JSON.stringify(arr));
    }

    function setGeoStatus(ok, text) {
      geoText.textContent = text;
      geoDot.classList.remove("bg-yellow-300", "bg-green-400", "bg-red-400");
      geoDot.classList.add(ok === "ok" ? "bg-green-400" : ok === "bad" ? "bg-red-400" : "bg-yellow-300");
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // 產出一個「文字摘要」給成果牆/分享卡/地圖 popup 用
    function buildSummary(missionId, payload) {
      if (missionId === "wish1") {
        const mood = payload.mood ? `｜${payload.mood}` : "";
        const tag  = payload.tag ? ` ${payload.tag}` : "";
        return `願望：${payload.text}${mood}${tag}`.trim();
      }
      if (missionId === "report1") {
        const sev = payload.severity ? `（${payload.severity}）` : "";
        const where = payload.where ? `｜${payload.where}` : "";
        return `問題：${payload.type}${sev}｜${payload.text}${where}`.trim();
      }
      if (missionId === "bio1") {
        const cnt = payload.count ? ` × ${payload.count}` : "";
        const note = payload.note ? `｜${payload.note}` : "";
        return `生物：${payload.name}${cnt}${note}`.trim();
      }
      return payload?.text || "";
    }

    function resetForms() {
      wishText.value = "";
      wishMood.value = "";
      wishTag.value = "";

      issueType.value = "";
      issueSeverity.value = "";
      issueText.value = "";
      issueWhere.value = "";

      spName.value = "";
      spCount.value = "";
      spNote.value = "";
    }

    function showForm(which) {
      formNone.classList.add("hidden");
      formWish.classList.add("hidden");
      formIssue.classList.add("hidden");
      formSpecies.classList.add("hidden");

      if (which === "wish1") formWish.classList.remove("hidden");
      else if (which === "report1") formIssue.classList.remove("hidden");
      else if (which === "bio1") formSpecies.classList.remove("hidden");
      else formNone.classList.remove("hidden");
    }

    // ---------------------------
    // Camera
    // ---------------------------
    async function startCamera() {
      try {
        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode }
        });
        video.srcObject = currentStream;
      } catch (e) {
        console.warn(e);
        alert("相機啟動失敗：請確認瀏覽器權限，且使用 HTTPS 或 localhost。");
      }
    }

    document.getElementById("switchCamBtn").addEventListener("click", async () => {
      facingMode = (facingMode === "environment") ? "user" : "environment";
      await startCamera();
    });

    // ---------------------------
    // Geolocation -> nearest spot
    // ---------------------------
    function detectLocation() {
      if (!navigator.geolocation) {
        setGeoStatus("bad", "此裝置不支援定位（仍可體驗任務）");
        // fallback: 用東海大學段示意
        userLoc.place = RIVER_SPOTS[0].name;
        userLoc.lat = RIVER_SPOTS[0].lat;
        userLoc.lon = RIVER_SPOTS[0].lon;
        refreshWall();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLoc.lat = pos.coords.latitude;
          userLoc.lon = pos.coords.longitude;

          let best = null;
          for (const s of RIVER_SPOTS) {
            const d = kmBetween(userLoc.lat, userLoc.lon, s.lat, s.lon);
            if (!best || d < best.d) best = { ...s, d };
          }

          if (best && best.d <= NEAR_RADIUS_KM) {
            userLoc.place = best.name;
            setGeoStatus("ok", `已鎖定：${best.name}（約 ${best.d.toFixed(1)} km）`);
          } else if (best) {
            userLoc.place = best.name + "（距離較遠）";
            setGeoStatus("warn", `附近最近：${best.name}（約 ${best.d.toFixed(1)} km）`);
          } else {
            setGeoStatus("warn", "定位成功，但未匹配點位");
          }

          refreshWall();
        },
        () => {
          setGeoStatus("bad", "定位被拒絕（仍可體驗任務）");
          // fallback: 用東海大學段示意，確保地圖仍會有行動點
          userLoc.place = RIVER_SPOTS[0].name + "（示意）";
          userLoc.lat = RIVER_SPOTS[0].lat;
          userLoc.lon = RIVER_SPOTS[0].lon;
          refreshWall();
        },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    }

    // ---------------------------
    // Missions UI
    // ---------------------------
    function renderMissions() {
      missionList.innerHTML = "";

      MISSIONS.forEach(m => {
        const isActive = m.id === selectedMissionId;
        const card = document.createElement("button");
        card.className =
          "text-left w-full rounded-2xl border p-4 flex items-start gap-3 active:scale-[0.99] transition " +
          (isActive ? "border-blue-400 bg-blue-50" : "border-gray-100 bg-white hover:bg-gray-50");

        card.innerHTML = `
          <div class="w-11 h-11 rounded-2xl ${isActive ? "river-bg text-white" : "bg-gray-100 text-gray-600"} flex items-center justify-center shrink-0">
            <i class="fa-solid ${m.icon}"></i>
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-center justify-between gap-2">
              <div class="font-black text-gray-800 truncate">${m.title}</div>
              <div class="text-[10px] font-black ${isActive ? "text-blue-700" : "text-gray-400"} shrink-0">
                +${m.points} 能量
              </div>
            </div>
            <div class="text-[11px] text-gray-400 mt-1">
              <span class="font-bold text-gray-500">${m.minutes} 分鐘</span> · ${m.hint}
            </div>
          </div>
        `;

        card.onclick = () => selectMission(m.id);
        missionList.appendChild(card);
      });
    }

    function selectMission(id) {
      selectedMissionId = id;
      const m = getMission(id);

      activeMissionBadge.textContent = `任務：${m.title}（+${m.points}）`;
      shutter.disabled = false;

      showForm(id);
      hint.textContent = "填好文字後按快門：照片 + 文字會一起進成果牆。";
      renderMissions();
    }

    // ---------------------------
    // 可視化：成果牆（地圖、統計、最新回報）
    // ---------------------------
    function initMapIfNeeded() {
      if (leafletMap) return;

      leafletMap = L.map("map", { zoomControl: false }).setView([24.18, 120.60], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap"
      }).addTo(leafletMap);

      markersLayer = L.layerGroup().addTo(leafletMap);

      // 標註點位（固定）
      RIVER_SPOTS.forEach(s => {
        L.circleMarker([s.lat, s.lon], { radius: 6 }).addTo(leafletMap).bindPopup(`點位：${s.name}`);
      });

      setTimeout(() => leafletMap.invalidateSize(), 200);
    }

    function refreshWall() {
      const actions = loadActions();
      const today = todayKey();
      const todays = actions.filter(a => a.dayKey === today);
      const todayCount = todays.length;
      const todayPoints = todays.reduce((sum, a) => sum + (a.points || 0), 0);

      document.getElementById("today-count").textContent = String(todayCount);
      document.getElementById("today-points").textContent = todayPoints.toLocaleString();

      const recentList = document.getElementById("recent-list");
      recentList.innerHTML = "";

      const recent = actions.slice(-8).reverse();
      if (recent.length === 0) {
        recentList.innerHTML = `
          <div class="rounded-2xl border border-gray-100 p-4 text-center">
            <div class="text-sm font-black text-gray-800">還沒有回報</div>
            <div class="text-[11px] text-gray-400 mt-1">完成第一個任務後，成果會出現在這裡。</div>
          </div>
        `;
      } else {
        recent.forEach(a => {
          const m = getMission(a.missionId);
          const row = document.createElement("div");
          row.className = "rounded-2xl border border-gray-100 p-3 flex items-center gap-3";
          row.innerHTML = `
            <div class="w-12 h-12 rounded-2xl overflow-hidden bg-gray-100 shrink-0">
              ${a.thumb ? `<img src="${a.thumb}" class="w-full h-full object-cover" alt="thumb">` : ""}
            </div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-between gap-2">
                <div class="font-black text-gray-800 truncate">${m ? m.title : "任務"}</div>
                <div class="text-[10px] font-black text-gray-400 shrink-0">${fmtTime(a.ts)}</div>
              </div>
              <div class="text-[11px] text-gray-400 mt-1 truncate">
                <i class="fa-solid fa-location-dot mr-1"></i>${a.place || "未定位"} · +${a.points} 能量
              </div>
              <div class="mt-1 text-[12px] font-black text-gray-700 truncate">
                ${esc(a.summary || "—")}
              </div>
            </div>
          `;
          recentList.appendChild(row);
        });
      }

      // Map markers (actions)
      initMapIfNeeded();
      markersLayer.clearLayers();

      // 若有定位，標自己
      if (userLoc.lat && userLoc.lon) {
        L.circleMarker([userLoc.lat, userLoc.lon], { radius: 8 }).addTo(markersLayer)
          .bindPopup(`你的位置：${userLoc.place || "已定位"}`);
        leafletMap.setView([userLoc.lat, userLoc.lon], 13);
      }

      // 行動點
      actions.slice(-30).forEach(a => {
        if (a.lat && a.lon) {
          L.circleMarker([a.lat, a.lon], { radius: 6 }).addTo(markersLayer)
            .bindPopup(`
              <div style="font-weight:900">+${a.points}｜${esc(getMission(a.missionId)?.title || "任務")}</div>
              <div style="margin-top:4px;font-size:12px;color:#6B7280">
                <i class="fa-solid fa-location-dot"></i> ${esc(a.place || "")}
              </div>
              <div style="margin-top:6px;font-size:13px;color:#111827;font-weight:800">
                ${esc(a.summary || "")}
              </div>
            `);
        }
      });

      setTimeout(() => leafletMap.invalidateSize(), 150);
    }

    // ---------------------------
    // 可分享：分享卡生成（含文字）
    // ---------------------------
    function makeShareCard({ photoDataUrl, missionTitle, points, place, ts, summary }) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const W = 1080, H = 1350; // IG 4:5
          shareCanvas.width = W;
          shareCanvas.height = H;
          const ctx = shareCanvas.getContext("2d");

          // 背景
          const g = ctx.createLinearGradient(0, 0, W, H);
          g.addColorStop(0, "#0ea5e9");
          g.addColorStop(1, "#2dd4bf");
          ctx.fillStyle = g;
          ctx.fillRect(0, 0, W, H);

          const pad = 70;
          const photoW = W - pad*2;
          const photoH = 780;
          const x = pad, y = pad;

          // 白色卡片
          roundRect(ctx, x-18, y-18, photoW+36, photoH+36, 48);
          ctx.fillStyle = "rgba(255,255,255,0.92)";
          ctx.fill();

          // draw photo cover
          const { sx, sy, sw, sh } = coverCrop(img.width, img.height, photoW, photoH);
          roundRect(ctx, x, y, photoW, photoH, 36);
          ctx.save();
          ctx.clip();
          ctx.drawImage(img, sx, sy, sw, sh, x, y, photoW, photoH);
          ctx.restore();

          // 下半部資訊
          const infoY = y + photoH + 58;

          // 標題 RiverQuest
          ctx.fillStyle = "rgba(255,255,255,0.95)";
          ctx.font = "900 64px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          ctx.fillText("RiverQuest", pad, infoY);

          // 任務
          ctx.font = "900 46px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          ctx.fillText(`完成：${missionTitle}`, pad, infoY + 86);

          // 點位與日期
          const d = new Date(ts);
          const dateStr = `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
          ctx.fillStyle = "rgba(255,255,255,0.85)";
          ctx.font = "700 32px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          ctx.fillText(`點位：${place || "未定位"}`, pad, infoY + 142);
          ctx.fillText(`時間：${dateStr}`, pad, infoY + 190);

          // ✅ 文字摘要（多行）
          ctx.fillStyle = "rgba(255,255,255,0.95)";
          ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          drawWrapText(ctx, summary || "", pad, infoY + 246, W - pad*2, 44, 2);

          // 能量徽章
          const badgeText = `守護能量 +${points}`;
          ctx.font = "900 40px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          const tw = ctx.measureText(badgeText).width;
          const bx = pad, by = infoY + 360, bw = tw + 70, bh = 86;

          roundRect(ctx, bx, by, bw, bh, 999);
          ctx.fillStyle = "rgba(0,0,0,0.25)";
          ctx.fill();
          ctx.fillStyle = "white";
          ctx.fillText(badgeText, bx + 35, by + 56);

          // slogan
          ctx.fillStyle = "rgba(255,255,255,0.85)";
          ctx.font = "800 30px system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
          ctx.fillText("把永續從「議題」變成「入口」", pad, H - 90);

          resolve(shareCanvas.toDataURL("image/png"));
        };
        img.src = photoDataUrl;
      });
    }

    function drawWrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines) {
      const words = String(text || "").split("");
      let line = "";
      let lines = 0;

      for (let i = 0; i < words.length; i++) {
        const testLine = line + words[i];
        const w = ctx.measureText(testLine).width;
        if (w > maxWidth && line) {
          ctx.fillText(line, x, y + lines * lineHeight);
          lines++;
          line = words[i];
          if (lines >= maxLines) {
            // 截斷 + …
            const rest = (line + words.slice(i+1).join("")).trim();
            const clipped = clipText(ctx, rest, maxWidth);
            ctx.fillText(clipped, x, y + lines * lineHeight);
            return;
          }
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, x, y + lines * lineHeight);
    }

    function clipText(ctx, text, maxWidth) {
      let t = text;
      while (ctx.measureText(t + "…").width > maxWidth && t.length > 0) {
        t = t.slice(0, -1);
      }
      return t.length ? (t + "…") : "…";
    }

    function roundRect(ctx, x, y, w, h, r) {
      const min = Math.min(w, h);
      if (r > min/2) r = min/2;
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    function coverCrop(srcW, srcH, dstW, dstH) {
      const srcRatio = srcW / srcH;
      const dstRatio = dstW / dstH;
      let sw, sh, sx, sy;
      if (srcRatio > dstRatio) {
        sh = srcH;
        sw = Math.floor(srcH * dstRatio);
        sx = Math.floor((srcW - sw) / 2);
        sy = 0;
      } else {
        sw = srcW;
        sh = Math.floor(srcW / dstRatio);
        sx = 0;
        sy = Math.floor((srcH - sh) / 2);
      }
      return { sx, sy, sw, sh };
    }

    // 生成縮圖（避免 localStorage 爆掉）
    function makeThumb(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const maxW = 240;
          const ratio = img.width / img.height;
          const w = maxW;
          const h = Math.round(maxW / ratio);

          const c = document.createElement("canvas");
          c.width = w;
          c.height = h;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          resolve(c.toDataURL("image/jpeg", 0.72));
        };
        img.src = dataUrl;
      });
    }

    // ---------------------------
    // 依任務拿 payload + 驗證必填
    // ---------------------------
    function getPayloadOrThrow() {
      if (!selectedMissionId) throw new Error("請先選擇任務");

      if (selectedMissionId === "wish1") {
        const text = (wishText.value || "").trim();
        if (!text) throw new Error("請先寫一句河的願望");
        return { text, mood: wishMood.value || "", tag: (wishTag.value || "").trim() };
      }

      if (selectedMissionId === "report1") {
        const type = issueType.value || "";
        const text = (issueText.value || "").trim();
        if (!type) throw new Error("請先選擇問題分類");
        if (!text) throw new Error("請先寫一句話描述問題");
        return { type, severity: issueSeverity.value || "", text, where: (issueWhere.value || "").trim() };
      }

      if (selectedMissionId === "bio1") {
        const name = (spName.value || "").trim();
        if (!name) throw new Error("請先輸入生物名稱");
        const count = spCount.value ? Number(spCount.value) : null;
        return { name, count, note: (spNote.value || "").trim() };
      }

      return {};
    }

    // ---------------------------
    // Action: takeAction() 完成任務
    // ---------------------------
    let lastAction = null;
    async function takeAction() {
      if (!selectedMissionId) return;

      // 驗證文字必填
      let payload;
      try {
        payload = getPayloadOrThrow();
      } catch (e) {
        alert(e.message || "請完成必填欄位");
        return;
      }

      // 拍照
      captureCanvas.width = video.videoWidth || 1280;
      captureCanvas.height = video.videoHeight || 720;
      const ctx = captureCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      const photoDataUrl = captureCanvas.toDataURL("image/png");
      document.getElementById("photo").src = photoDataUrl;

      const m = getMission(selectedMissionId);

      // Confetti
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ["#0ea5e9", "#2dd4bf", "#ffffff"]
      });

      const ts = Date.now();
      const thumb = await makeThumb(photoDataUrl);

      const summary = buildSummary(selectedMissionId, payload);

      const action = {
        ts,
        dayKey: todayKey(ts),
        missionId: selectedMissionId,
        points: m.points,
        place: userLoc.place,
        lat: userLoc.lat,
        lon: userLoc.lon,
        thumb,
        photoDataUrl,   // demo 可留
        payload,        // ✅ 新增：任務文字資料
        summary         // ✅ 新增：摘要（成果牆/地圖/分享卡）
      };

      const actions = loadActions();
      actions.push(action);

      // 控制 actions 容量（避免無限長）
      const capped = actions.slice(-80);
      saveActions(capped);

      // 更新總能量
      const startPoints = loadTotalPoints();
      const endPoints = startPoints + m.points;
      saveTotalPoints(endPoints);

      // Modal 文案
      document.getElementById("modal-title").textContent = `守護能量 +${m.points}`;
      document.getElementById("modal-sub").textContent = `已同步：${m.title} · ${userLoc.place || "未定位"}`;
      document.getElementById("modal-summary-text").textContent = summary || "—";

      // 數字跳動回饋
      animatePoints(startPoints, endPoints);

      // 顯示完成彈窗
      lastAction = action;
      setTimeout(() => {
        document.getElementById("modal").classList.remove("hidden");
      }, 450);

      // 更新成果牆
      refreshWall();

      // ✅ 送出後保留任務但清空文字（避免下一次誤送）
      resetForms();
      showForm(selectedMissionId);
    }

    function animatePoints(from, to) {
      let val = from;
      const step = Math.max(1, Math.round((to - from) / 25));
      const timer = setInterval(() => {
        val += step;
        if (val >= to) {
          val = to;
          clearInterval(timer);
        }
        pointsDisp.textContent = val.toLocaleString();
      }, 20);
    }

    // ---------------------------
    // Modals & Tabs
    // ---------------------------
    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    function closeModalToWall() {
      closeModal();
      switchTab("wall");
    }

    function switchTab(tab) {
      const quest = document.getElementById("tab-quest");
      const wall = document.getElementById("tab-wall");
      const btnQuest = document.getElementById("btn-quest");
      const btnWall = document.getElementById("btn-wall");

      if (tab === "quest") {
        quest.classList.remove("hidden");
        wall.classList.add("hidden");
        btnQuest.className = "river-bg text-white font-black py-3 rounded-2xl shadow-lg shadow-blue-500/20 active:scale-[0.99] transition";
        btnWall.className = "bg-gray-100 text-gray-700 font-black py-3 rounded-2xl active:scale-[0.99] transition";
      } else {
        quest.classList.add("hidden");
        wall.classList.remove("hidden");
        btnWall.className = "river-bg text-white font-black py-3 rounded-2xl shadow-lg shadow-blue-500/20 active:scale-[0.99] transition";
        btnQuest.className = "bg-gray-100 text-gray-700 font-black py-3 rounded-2xl active:scale-[0.99] transition";
        refreshWall();
      }
    }

    // 分享卡
    async function openShareCard() {
      if (!lastAction) return;

      const m = getMission(lastAction.missionId);
      const dataUrl = await makeShareCard({
        photoDataUrl: lastAction.photoDataUrl,
        missionTitle: m ? m.title : "任務",
        points: lastAction.points,
        place: lastAction.place,
        ts: lastAction.ts,
        summary: lastAction.summary || ""
      });

      document.getElementById("sharePreview").src = dataUrl;
      const dl = document.getElementById("downloadBtn");
      dl.href = dataUrl;

      document.getElementById("shareModal").classList.remove("hidden");
    }

    function closeShare() {
      document.getElementById("shareModal").classList.add("hidden");
    }

    async function nativeShare() {
      const img = document.getElementById("sharePreview");
      const dataUrl = img.src;
      if (!dataUrl) return;

      if (navigator.canShare && navigator.share) {
        try {
          const blob = await (await fetch(dataUrl)).blob();
          const file = new File([blob], "RiverQuest_share.png", { type: "image/png" });

          if (navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: "RiverQuest",
              text: "我用 10 分鐘完成了一個 RiverQuest 任務！",
              files: [file]
            });
            return;
          }
          alert("此裝置不支援直接分享圖片檔案，請改用「下載」。");
        } catch (e) {
          console.warn(e);
          alert("分享失敗，請改用「下載」。");
        }
      } else {
        alert("此瀏覽器不支援原生分享，請改用「下載」。");
      }
    }

    // 清除資料
    function clearDemoData() {
      localStorage.removeItem(LS_ACTIONS);
      localStorage.removeItem(LS_POINTS);
      pointsDisp.textContent = loadTotalPoints().toLocaleString();
      refreshWall();
      alert("已清除 demo 資料。");
    }

    // ---------------------------
    // Init
    // ---------------------------
    function init() {
      // Points init
      const p = loadTotalPoints();
      pointsDisp.textContent = p.toLocaleString();

      // Missions init
      renderMissions();

      // Start camera & location
      startCamera();
      detectLocation();

      // 初始成果牆
      refreshWall();

      // 初始 form
      showForm(null);
    }

    init();
  </script>
</body>
</html>
